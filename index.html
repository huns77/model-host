<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>상품 3D/AR 미리보기</title>

  <!-- ✅ model-viewer for Mobile -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/1.12.0/model-viewer.min.js"></script>

  <!-- ✅ Three.js importmap -->
  <script type="importmap">
    
    {
      "imports": {
        "three": "https://unpkg.com/three@0.166.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.166.1/examples/jsm/"
      }
    }
  </script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f4f4f4;
      overflow: hidden;
    }

    #viewer-container {
      width: 600px;
      height: 600px;
      display: none;
      position: relative;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    model-viewer {
      width: 100%;
      height: 100vh;
      display: none;
      --ar-button-display: block;
    }

    button[slot="ar-button"] {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }
  </style>
</head>
<body>

  <!-- PC용 뷰어 -->
  <div id="viewer-container"></div>

  <!-- 모바일용 Model Viewer -->
  <model-viewer
    id="mobile-model"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    auto-rotate
    exposure="1"
    shadow-intensity="1"
    disable-pan
    disable-zoom
    environment-image="neutral"
  >
    <button slot="ar-button">AR로 보기</button>
  </model-viewer>

  <script type="module">
    
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    function getProductCode() {
        const params = new URLSearchParams(window.location.search);
        return params.get("product");  // 기본값 설정 가능
    }
    
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const productCode = getProductCode();
    console.log("productCode : " + productCode);
    const glbUrl = `https://huns77.github.io/model-host/models/${productCode}.glb`;
    const usdzUrl = `https://camplan0801.cafe24.com/models/table.usdz`;
    console.log(glbUrl);
    console.log(usdzUrl);
    const modelViewer = document.getElementById("mobile-model");
    const viewerContainer = document.getElementById("viewer-container");

    if (isMobile) {
      modelViewer.setAttribute("src", glbUrl);
      modelViewer.setAttribute("ios-src", usdzUrl);
      modelViewer.style.display = "block";
    } else {
      viewerContainer.style.display = "block";

      // --- Three.js 초기화 ---
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
      camera.position.set(0, 0, 5);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(600, 600);
      viewerContainer.appendChild(renderer.domElement);

      const ambient = new THREE.AmbientLight(0xffffff, 1.5);
      scene.add(ambient);

      const light = new THREE.DirectionalLight(0xffffff, 1.5);
      light.position.set(5, 10, 7.5);
      scene.add(light);

      const loader = new GLTFLoader();
      loader.load(glbUrl, (gltf) => {
        const model = gltf.scene;
        scene.add(model);

        // 모델 중앙 정렬
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 4.5 / maxDim;
        model.position.sub(center);
        model.scale.set(scale, scale, scale);
      }, undefined, (err) => {
        console.error('GLB 모델 로딩 실패:', err);
      });

      const animate = () => {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      };
      animate();
    }
  </script>
</body>
</html>
